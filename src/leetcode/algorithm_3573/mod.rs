pub struct Solution;

impl Solution {
    pub fn maximum_profit(prices: Vec<i32>, k: i32) -> i64 {
        let k = k as usize;
        let n = prices.len();
        let mut dp = vec![vec![vec![i64::MIN; 3]; k + 1]; prices.len()];
        dp[0][0][0] = 0;
        dp[0][1][1] = -prices[0] as i64;
        dp[0][1][2] = prices[0] as i64;
        for (i, price) in prices.into_iter().enumerate().skip(1) {
            let price = price as i64;
            for j in (0..=k).rev() {
                dp[i][j][0] = dp[i - 1][j][0]
                    .max(dp[i - 1][j][1] + price)
                    .max(dp[i - 1][j][2].saturating_sub(price));
                dp[i][j][1] = dp[i - 1][j][1];
                if j > 0 {
                    dp[i][j][1] = dp[i][j][1].max(dp[i - 1][j - 1][0].saturating_sub(price))
                }
                dp[i][j][2] = dp[i - 1][j][2];
                if j > 0 {
                    dp[i][j][2] = dp[i][j][2].max(dp[i - 1][j - 1][0] + price)
                }
            }
        }
        dp.remove(n - 1)
            .into_iter()
            .map(|v| v[0])
            .max()
            .unwrap_or_default()
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use test_case::test_case;

    #[test_case(vec![1,7,9,8,2], 2 => 14; "example 1")]
    #[test_case(vec![12,16,19,19,8,1,19,13,9], 3 => 36; "example 2")]
    #[test_case(vec![439905949,666304906,328728050,996405752,379313886,528209791,88582883,939135548,751069794,109146128,883868801,685035870,872864534,515610456,671402135,299270187,782796059,14959721,863144680,901085624,622229387,536656476,257303050,868839354,117275933,918430202,935695732,478547107,484151756,631419928,39696098,650941214,51074234,941181946,265314584,557086091,786537782,50596574,28828693,157162091,9857934,451956750,695591748,879988702,249629554,539569656,282083076,39183395,66614080,479066152,652564309,907349719,210005879,768785742,537258749,237393978,346271286,392541722,312074103,126562356,400828204,614474102,364762040,8363356,539354781,90084496,319405489,644955686,889207045,798527610,141688158,529097227,598399178,87898767,830035760,49071715,600386530,40425784,322514114,778707680,79388396], 30 => 17891684807; "case 1")]
    fn test_solution(prices: Vec<i32>, k: i32) -> i64 {
        Solution::maximum_profit(prices, k)
    }
}
